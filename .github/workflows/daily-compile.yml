name: Daily Compile JSON to SRS

on:
  schedule:
    - cron: '0 0 * * *'  # 每天凌晨UTC时间
  workflow_dispatch:     # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git credentials
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Download sing-box
        run: |
          curl -L https://github.com/SagerNet/sing-box/releases/download/v1.1.9/sing-box-1.1.9-linux-amd64.tar.gz -o sing-box.tar.gz
          tar -xvf sing-box.tar.gz
          chmod +x sing-box-1.1.9-linux-amd64/sing-box
          mv sing-box-1.1.9-linux-amd64/sing-box ./sing-box

      - name: Create output directory
        run: |
          mkdir -p rules
          chmod 777 rules

      - name: Compile JSON to SRS
        run: |
          for file in rules/*.json; do
            output_file="rules/$(basename "${file%.*}").srs"
            echo "Compiling $file to $output_file"
            ./sing-box rule-set compile --input "$file" --output "$output_file"
          done

      - name: Verify generated files
        run: |
          ls -l rules/*.srs

      - name: Commit and push SRS files
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add rules/*.srs
          git commit -m "Add compiled SRS files" --allow-empty
          git push origin HEAD:${{ github.ref }}

      - name: Upload compiled SRS files
        uses: actions/upload-artifact@v4
        with:
          name: srs-files
          path: rules/*.srs
